#!/bin/bash
gui=$(cat <<EOF
GUI {
Horizontally@bottom?"bot":"top" {
    prompt=Label(label=pstring,highlight=1);
    input=Input(minwidth=200);
    list=HList();
  }
}
EOF
)
for arg in "$@"; do
if [ "$arg" = '-l' ]; then
    gui=$(cat <<EOF
GUI {
Horizontally@bottom?"bot":"top" {
  Vertically {
    prompt=Label(label=pstring,highlight=1);
    Blank;
  }
  Vertically {
    input=Input(minwidth=0);
    list=VList(lines=lines);
  }
}
}
option lines (-l,,"List items vertically, with the given number of lines.", "INTEGER", 10)
EOF
    )
fi
done
code=$(cat <<EOF
option pstring (-p,--prompt,"Set the input prompt", "STRING", "")
option bottom (-b,,"Appear at bottom of screen")
stdin->lines(lines) { list.insert(lines) }
BEGIN { focus input }
<C-g> { exit 1 }
<Up> || <C-p> { list.prev() }
<Down> || <C-n> { list.next() }
<Return> { print list.selected || input.value; exit }
<Shift-Return> { print input.value; exit }
<C-i> || <Tab> { if (list.selected) { input.value = list.selected } }
input.value->changed(from, to) { list.filter(to) }
EOF
)
exec -a dmenu sindre -e "$gui" -e "$code" "$@"
